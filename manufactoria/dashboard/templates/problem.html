{% extends "base.html" %}

{% block title %}{{ problem.name or 'Problem ' + problem.id|string }} - Manufactoria Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-cog me-2"></i>
        {{ problem.name or 'Untitled Problem' }}
    </h1>
    <div>
        <a href="{{ url_for('edit_problem', problem_id=problem.id) }}" class="btn btn-warning">
            <i class="fas fa-edit me-1"></i>Edit
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to List
        </a>
    </div>
</div>

<div class="row">
    <!-- Problem Information -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Problem Information
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">ID:</dt>
                    <dd class="col-sm-9">{{ problem.id }}</dd>
                    
                    <dt class="col-sm-3">Name:</dt>
                    <dd class="col-sm-9">{{ problem.name or 'Untitled' }}</dd>
                    
                    <dt class="col-sm-3">Difficulty:</dt>
                    <dd class="col-sm-9">
                        {% set difficulty = problem.get('difficulty', 'basic') %}
                        {% if difficulty == 'basic' %}
                            <span class="badge bg-success">{{ difficulty.title() }}</span>
                        {% elif difficulty == 'easy' %}
                            <span class="badge bg-info">{{ difficulty.title() }}</span>
                        {% elif difficulty == 'medium' %}
                            <span class="badge bg-warning">{{ difficulty.title() }}</span>
                        {% elif difficulty == 'hard' %}
                            <span class="badge bg-danger">{{ difficulty.title() }}</span>
                        {% elif difficulty == 'advanced' %}
                            <span class="badge bg-dark">{{ difficulty.title() }}</span>
                        {% elif difficulty == 'expert' %}
                            <span class="badge bg-primary">{{ difficulty.title() }}</span>
                        {% elif difficulty == 'god' %}
                            <span class="badge bg-secondary">{{ difficulty.title() }}</span>
                        {% else %}
                            <span class="badge bg-light text-dark">{{ difficulty.title() }}</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Type:</dt>
                    <dd class="col-sm-9">
                        {% if problem.problem_type %}
                            <span class="badge bg-primary">
                                <i class="fas fa-tag me-1"></i>{{ problem.problem_type.replace('_', ' ').title() }}
                            </span>
                        {% else %}
                            <em class="text-muted">No type specified</em>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Color Mode:</dt>
                    <dd class="col-sm-9">
                        {% if problem.color_mode %}
                            {% if problem.color_mode == 'two_color' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-palette me-1"></i>Two Color (RB)
                                </span>
                            {% elif problem.color_mode == 'four_color' %}
                                <span class="badge bg-warning">
                                    <i class="fas fa-palette me-1"></i>Four Color (RBYG)
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-palette me-1"></i>{{ problem.color_mode.replace('_', ' ').title() }}
                                </span>
                            {% endif %}
                        {% else %}
                            <em class="text-muted">Not specified</em>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Description:</dt>
                    <dd class="col-sm-9">
                        {% if problem.description %}
                            {{ problem.description }}
                        {% else %}
                            <em class="text-muted">No description provided</em>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Criteria:</dt>
                    <dd class="col-sm-9">
                        {% if problem.criteria %}
                            <div class="bg-primary bg-opacity-10 border border-primary p-3 rounded">
                                <strong class="text-primary">
                                    <i class="fas fa-clipboard-check me-2"></i>Acceptance Criteria:
                                </strong>
                                <p class="mb-0 mt-2 text-dark">{{ problem.criteria }}</p>
                            </div>
                        {% else %}
                            <em class="text-muted">No criteria specified</em>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Created:</dt>
                    <dd class="col-sm-9">
                        {% if problem.created_at %}
                            {{ problem.created_at }}
                        {% else %}
                            <em class="text-muted">Unknown</em>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">Updated:</dt>
                    <dd class="col-sm-9">
                        {% if problem.updated_at %}
                            {{ problem.updated_at }}
                        {% else %}
                            <em class="text-muted">Unknown</em>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>

    <!-- Available Nodes -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cubes me-2"></i>Available Node Types
                </h5>
            </div>
            <div class="card-body">
                {% if problem.available_nodes %}
                    <div class="row">
                        {% for node in problem.available_nodes %}
                        <div class="col-md-6 mb-2">
                            <span class="badge bg-secondary">
                                <i class="fas fa-cube me-1"></i>{{ node }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <em class="text-muted">No node types specified</em>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Test Cases -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-vial me-2"></i>Test Cases
            {% if problem.test_cases %}
                <span class="badge bg-info ms-2">{{ problem.test_cases|length }} cases</span>
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        {% if problem.test_cases %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Input</th>
                            <th>Expected Output</th>
                            <th>Expected Accepted</th>
                            <th>Check Output</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test_case in problem.test_cases %}
                        <tr>
                            <td>
                                <code class="bg-light p-1">{{ test_case.input or '""' }}</code>
                            </td>
                            <td>
                                <code class="bg-light p-1">{{ test_case.expected_output or '""' }}</code>
                            </td>
                            <td>
                                {% if test_case.expected_accepted %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Accepted
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>Rejected
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if test_case.get('check_output', True) %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-check me-1"></i>Yes
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-times me-1"></i>No
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {{ test_case.description or '' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-3">
                <i class="fas fa-vial text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">No test cases defined</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Solutions -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-code me-2"></i>Solutions
            {% if problem.solutions %}
                <span class="badge bg-success ms-2">{{ problem.solutions|length }} solutions</span>
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        {% if problem.solutions %}
            {% for solution in problem.solutions %}
            <div class="solution-item mb-4" {% if not loop.last %}style="border-bottom: 1px solid #dee2e6; padding-bottom: 1rem;"{% endif %}>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-1"></i>
                        {{ solution.name or 'Solution ' + loop.index|string }}
                    </h6>
                    {% if problem.test_cases %}
                    <button class="btn btn-sm btn-outline-primary test-solution-btn" 
                            data-solution-index="{{ loop.index0 }}">
                        <i class="fas fa-play me-1"></i>Test Solution
                    </button>
                    {% endif %}
                </div>
                
                {% if solution.description %}
                <p class="text-muted small mb-2">{{ solution.description }}</p>
                {% endif %}
                
                <pre class="bg-dark text-light p-3 rounded"><code>{{ solution.code or '' }}</code></pre>
                
                <!-- Test Results (will be populated by JavaScript) -->
                <div id="testResults{{ loop.index0 }}" class="test-results mt-3" style="display: none;"></div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-3">
                <i class="fas fa-code text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2">No solutions provided</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Hidden data for JavaScript -->
<script type="application/json" id="problem-data">
{
    "solutions": {{ problem.solutions|tojson|safe }},
    "test_cases": {{ problem.test_cases|tojson|safe }}
}
</script>

<script>
// Get problem data
const problemData = JSON.parse(document.getElementById('problem-data').textContent);

// Test solution functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.test-solution-btn')) {
        const button = e.target.closest('.test-solution-btn');
        const solutionIndex = parseInt(button.getAttribute('data-solution-index'));
        
        if (problemData.solutions[solutionIndex] && problemData.test_cases) {
            testSolution(problemData.solutions[solutionIndex].code, problemData.test_cases, solutionIndex, button);
        }
    }
});

function testSolution(dslCode, testCases, solutionIndex, button) {
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
    button.disabled = true;
    
    fetch('/api/test_solution', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            dsl: dslCode,
            test_cases: testCases
        })
    })
    .then(response => response.json())
    .then(data => {
        displayTestResults(data, solutionIndex);
        button.innerHTML = originalText;
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Error testing solution');
    });
}

function displayTestResults(data, solutionIndex) {
    const resultsDiv = document.getElementById(`testResults${solutionIndex}`);
    
    if (!data.valid) {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Invalid DSL:</strong> ${data.message}
            </div>
        `;
        resultsDiv.style.display = 'block';
        return;
    }
    
    const allPassed = data.all_passed;
    const results = data.results;
    
    let html = `
        <div class="alert ${allPassed ? 'alert-success' : 'alert-warning'}">
            <i class="fas ${allPassed ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
            <strong>${allPassed ? 'All tests passed!' : 'Some tests failed'}</strong>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Input</th>
                        <th>Expected</th>
                        <th>Actual</th>
                        <th>Finished?</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    results.forEach(result => {
        const passedClass = result.passed ? 'table-success' : 'table-danger';
        const passedIcon = result.passed ? 'fa-check' : 'fa-times';
        
        // Show output comparison only if check_output is true
        const outputDisplay = result.check_output 
            ? `<code>${result.actual_output || '""'}</code>`
            : '<span class="text-muted"><i>Not checked</i></span>';
        
        const expectedDisplay = result.check_output 
            ? `<code>${result.expected_output || '""'}</code>`
            : '<span class="text-muted"><i>Not checked</i></span>';
        
        html += `
            <tr class="${passedClass}">
                <td><code>${result.input || '""'}</code></td>
                <td>${expectedDisplay}</td>
                <td>${outputDisplay}</td>
                <td>
                    <span class="badge ${result.actual_accepted ? 'bg-success' : 'bg-danger'}">
                        ${result.actual_accepted ? 'Yes' : 'No'}
                    </span>
                </td>
                <td>
                    <i class="fas ${passedIcon}"></i>
                    ${result.passed ? 'PASS' : 'FAIL'}
                    ${!result.check_output ? ' <small class="text-muted">(acceptance only)</small>' : ''}
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = 'block';
}
</script>
{% endblock %} 